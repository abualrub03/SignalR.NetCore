@model ViewModel.HomePageViewModel
@{
    ViewData["Title"] = "_Chat";
    Layout = "_DashboardLayout";
}
<script src="~/lib/microsoft/signalr/dist/browser/signalr.js"></script>
<style>
	#uploadedImage {
		position: relative; /* Allow positioning of the close image */
	}

	#close {
		display: block; /* Hide the close image initially */
		position: absolute;
		top: 10px;
		right: 10px;
		z-index: 1; /* Ensure it's above the uploaded image */
	}

	#uploadedImage:hover #close {
		display: block; /* Show the close image on hover */
	}

</style>
@section scripts{
    <script type="text/javascript">
		// Assuming you have a function to handle image removal:
		function removeImage() {
			// ... your code to remove the image
		}

		// Add an event listener to the close image:

		$(function () {
			$("#msgContainer")[0].scrollIntoView(false)
		});
		$("#messageInput").keydown(function (event) {
			if (event.key === "Enter") {
				var message = $(this).val();
				connection.invoke("SendToUser", @Model.account.Id , @Model.accounts[0].Id , message ,'text').catch(function (err) {
					return console.error(err.toString());
				});
				event.preventDefault();
				sentMessage(message);
				$("#msgContainer")[0].scrollIntoView(false)
				$(this).val("");
			}
		});
		setInterval(function () {
			$.ajax({
				url: "/Home/CheckActivity",
				method: "POST",
				data: {
					Id: "@Model.accounts[0].Id"	,
				},
				success: function (data) {
					if ( data == 1) {
						document.getElementById("statusChat").innerHTML =
							`<i class="material-icons online">fiber_manual_record</i>`;
						document.getElementById("ActiveInActive").innerHTML =
							`<span>Active Now</span>`;
					} else {
						document.getElementById("statusChat").innerHTML =
							`<i class="material-icons offline">fiber_manual_record</i>`;
						document.getElementById("ActiveInActive").innerHTML =
							`<span>Inactive</span>`;
					}				
				},
				error: function (error) {
					consoe.log("error");
				}
			});
		}, 0.1 * 60 * 1000);
		function recevedMessage(user,message) {
			if (@Model.accounts[0].Id == user) {
				document.getElementById("msgContainer").innerHTML +=
					`<div class="message">
						<img class="avatar-md" src="/img/avatars/avatar-female-5.jpg" data-toggle="tooltip" data-placement="top" title="Keith" alt="avatar">
						<div class="text-main">
							<div class="text-group">
								<div class="text">
									<p> ` + message +  ` </p>
								</div>
							</div>
						</div>
					</div>`;
				$("#msgContainer")[0].scrollIntoView(false)
			}
		}
		function sentMessage(message) {
			document.getElementById("msgContainer").innerHTML +=
				`<div class="message me">
					<div class="text-main">
						<div class="text-group me">
							<div class="text me">
								<p> ` + message + ` </p>
							</div>
						</div>
					</div>
				</div>`;
			$("#msgContainer")[0].scrollIntoView(false)

		}
		function recevedImage(user, message) {
			if (@Model.accounts[0].Id == user) {
				document.getElementById("msgContainer").innerHTML +=
					`<div class="message">
											<img class="avatar-md" src="/img/avatars/avatar-female-5.jpg" data-toggle="tooltip" data-placement="top" title="Keith" alt="avatar">
											<div class="text-main">
												<div class="text-group">
													<div class="text">
														<div class="chat-message chat-message-image">
																			<img src="`+message+`" style="width: 300px" alt="Image description">
														</div>
													</div>
												</div>
											</div>
										</div>`;
				$("#msgContainer")[0].scrollIntoView(false)
			}
		}
        function sentImage(path) {
			document.getElementById("msgContainer").innerHTML +=
				`<div class="message me">
					<div class="text-main">
						<div class="text-group me">
							<div class="text me">
								<div class="chat-message chat-message-image">
									<img src="`+ path + `" style="width:300px" alt="Image description">
								</div>
							</div>
						</div>
					</div>
				</div>`;
			$("#msgContainer")[0].scrollIntoView(false)
		}
        document.getElementById("sendToUser").addEventListener("click", function (event) {
			var message = document.getElementById("messageInput").value;
			connection.invoke("SendToUser", @Model.account.Id , @Model.accounts[0].Id ,message , 'text' ).catch(function (err) {
                return console.error(err.toString());
            });
            event.preventDefault();
			sentMessage(message);
			$("#msgContainer")[0].scrollIntoView(false)
        });
		/////////////////////////////////////////////////////////////////////////////////
		$('#imageUpload').change(function () {


			var file = this.files[0];

			// Preview the image using FileReader
			if (file) {
				var reader = new FileReader();
				reader.onload = function (e) {
					
					document.getElementById("iamgesContainer").innerHTML =
						`<img id="uploadedImage" style="width: 100px; height: 100px; margin-right: 30px;" src="`+e.target.result+`" id="impPrev" />
													<button> <img src="/img/close.png" id="close" style="position: absolute; top: 5px; right: 35px;width:20px;" /></button>
						`;

					document.getElementById("content").style.marginBottom = "-70px";
					document.getElementById("bottom").style.marginTop = "30px";
					

					

				};
				reader.readAsDataURL(file);
			}
		

			
			var formData = new FormData();
			formData.append('image', file);
			formData.append('senderId', '@Model.account.Id');
			formData.append('recieverId', '@Model.accounts[0].Id');

			$.ajax({
				url: '/Home/UploadImage',
				type: 'POST',
				data: formData,
				contentType: false, // Required for FormData
				processData: false, // Required for FormData
				success: function (path) {
					sentImage(path);
					connection.invoke("SendToUser", @Model.account.Id, @Model.accounts[0].Id, path, 'image')
						.catch(function (err) {
							console.error(err.toString());
						});
				},
				error: function (error) {
					// Handle errors here
				}
			});
		});

		

	</script>
}
<div class="tab-content" id="nav-tabContent">
	<!-- Start of Babble -->
	<div class="babble tab-pane fade active show" id="list-chat" role="tabpanel" aria-labelledby="list-chat-list">
		<!-- Start of Chat -->
		<div class="chat" id="chat1">
			<div class="top">
				
				<div class="container">
					<div class="col-md-12">
						<div class="inside">
							<a href="#"><img class="avatar-md" src="/img/avatars/avatar-female-1.jpg" data-toggle="tooltip" data-placement="top" title="Keith" alt="avatar"></a>
							<div class="status" id="statusChat">
								@if (Model.accounts[0].IsActive == 1)
								{
									<i class="material-icons online">fiber_manual_record</i>
								}
								else
								{
									<i class="material-icons offline">fiber_manual_record</i>
								}
							</div>
							<div class="data">
								<h5><a href="#">@Model.accounts[0].FullName</a></h5>
								<span id="ActiveInActive">
									@if (Model.accounts[0].IsActive == 1)
									{
										<span>Active now</span>
									}
									else
									{
										<span>Inactive</span>
									}
								</span>
							</div>
							<div class="dropdown">
								<button class="btn" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="material-icons md-30">more_vert</i></button>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="content" id="content" style="">
				<div id="msgContainer" class="container">
					@foreach (var i in Model.listMessages)
					{	
						if(i.messageType != "text")
						{
							if (i.messageSenderId == Model.account.Id)
							{
								<div class="message me">
									<div class="text-main">
										<div class="text-group me">
											<div class="text me">
												<div class="chat-message chat-message-image">
													<img src="@i.messagePathIfExist" style="width:300px" alt="Image description">
												</div>
											</div>
										</div>
									</div>
								</div>

								
							}
							else
							{
								<div class="message">
									<img class="avatar-md" src="/img/avatars/avatar-female-5.jpg" data-toggle="tooltip" data-placement="top" title="Keith" alt="avatar">
									<div class="text-main">
										<div class="text-group">
											<div class="text">
												<div class="chat-message chat-message-image">
													<img src="@i.messagePathIfExist" style="width:300px" alt="Image description">
												</div>
											</div>
										</div>
									</div>
								</div>
							}
	
						}
						else
						{
							if (i.messageSenderId == Model.account.Id)
							{
								<div class="message me">
									<div class="text-main">
										<div class="text-group me">
											<div class="text me">
												<p> @i.messageContent </p>
											</div>

										</div>
										<span>@i.messageDateTime</span>
									</div>
								</div>
							}
							else
							{
								<div class="message">
									<img class="avatar-md" src="/img/avatars/avatar-female-5.jpg" data-toggle="tooltip" data-placement="top" title="Keith" alt="avatar">
									<div class="text-main">
										<div class="text-group">
											<div class="text">
												<p> @i.messageContent </p>
											</div>

										</div>
										<span>@i.messageDateTime</span>
									</div>
								</div>
							}
						}
						
					}
					<div  id="scrollToMe"></div>
					
                </div>
			</div>

			<div class="container" style="
    background-color: white;
    position: relative;
">
				<div class="col-md-12">
					<div id="bottom"class="bottom" style="
">

						<div style="position: relative;" id="iamgesContainer" >
						</div>

						<div class="position-relative w-100">
							
							<textarea class="form-control" id="messageInput" placeholder="Start typing for reply..." rows="1"> </textarea>
							
							<button type="button" id="sendToUser" class="btn send"><i class="material-icons">send</i></button>

						</div>

						<label>
							<input type="file" type="file" id="imageUpload" accept="image/*" >
							<span class="btn attach d-sm-block d-none"><i class="material-icons">attach_file</i></span>
						</label>
					</div>
				</div>
			</div>
		</div>
		<!-- End of Chat -->
		<!-- Start of Call -->
		<div class="call" id="call1">
			<div class="content">
				<div class="container">
					<div class="col-md-12">
						<div class="inside">
							<div class="panel">
								<div class="participant">
									<img class="avatar-xxl" src="/img/avatars/avatar-female-5.jpg" alt="avatar">
									<span>Connecting</span>
								</div>
								<div class="options">
									<button class="btn option"><i class="material-icons md-30">mic</i></button>
									<button class="btn option"><i class="material-icons md-30">videocam</i></button>
									<button class="btn option call-end"><i class="material-icons md-30">call_end</i></button>
									<button class="btn option"><i class="material-icons md-30">person_add</i></button>
									<button class="btn option"><i class="material-icons md-30">volume_up</i></button>
								</div>
								<button class="btn back" name="1"><i class="material-icons md-24">chat</i></button>

							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- End of Call -->
	</div>
	<!-- End of Babble -->	
</div>